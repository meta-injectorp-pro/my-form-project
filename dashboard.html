<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Affiliate Dashboard - Meta Injector Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { background-color: #0F0A1E; font-family: 'Plus Jakarta Sans', sans-serif; color: white; }
    .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
    .glass-card { background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
    .glass-card:hover { border-color: rgba(160, 115, 238, 0.3); transform: translateY(-2px); }
    /* Payment Method Style */
    .payment-radio:checked + div { border-color: #fd297b; background: rgba(253, 41, 123, 0.1); }
    .payment-radio:checked + div .check-icon { opacity: 1; transform: scale(1); }
  </style>
</head>

<body x-data="{ currentTab: 'dashboard', mobileMenu: false }" class="antialiased min-h-screen flex overflow-hidden">
  
  <aside class="fixed lg:static inset-y-0 left-0 z-50 w-64 glass-panel border-r border-white/10 transition-transform duration-300 transform lg:translate-x-0" :class="mobileMenu ? 'translate-x-0' : '-translate-x-full'">
     <div class="h-full flex flex-col">
        <div class="p-6 border-b border-white/10"><img src="./Source_Files/logo.svg" alt="Meta Injector Pro" class="h-8"></div>
        <nav class="flex-1 p-4 space-y-2">
            <button @click="currentTab = 'dashboard'" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5" :class="currentTab === 'dashboard' ? 'bg-[#A073EE]/20 text-[#A073EE]' : ''">Overview</button>
            <button @click="currentTab = 'withdraw'" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5" :class="currentTab === 'withdraw' ? 'bg-[#fd297b]/20 text-[#fd297b]' : ''">Withdraw</button>
            <button @click="currentTab = 'history'" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5" :class="currentTab === 'history' ? 'bg-[#A073EE]/20 text-[#A073EE]' : ''">History</button>
        </nav>
        <div class="p-4"><button onclick="window.logout()" class="w-full py-3 text-red-400 hover:bg-red-500/10 rounded-lg">Logout</button></div>
        
        <div class="p-4 border-t border-white/10">
            <div class="flex items-center gap-3 p-3 rounded-lg bg-white/5">
                <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center overflow-hidden">
                    <img src="https://ui-avatars.com/api/?name=User&background=A073EE&color=fff" id="userAvatar" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate profile-name">Loading...</p>
                    <p class="text-xs text-gray-400 truncate profile-id">ID: ...</p>
                </div>
            </div>
        </div>
      </div>
  </aside>

  <main class="flex-1 h-screen overflow-y-auto p-6 lg:p-10 max-w-7xl mx-auto">
    <div x-show="currentTab === 'dashboard'" x-transition.opacity>
        <h1 class="text-3xl font-bold mb-6">Dashboard Overview</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
            <div class="glass-card p-6 rounded-2xl">
                <p class="text-gray-400 text-sm">Available Balance</p>
                <h3 class="text-3xl font-bold text-white balance-display">৳ 0</h3>
            </div>
            <div class="glass-card p-6 rounded-2xl">
                <p class="text-gray-400 text-sm">Total Earnings</p>
                <h3 class="text-3xl font-bold text-white earning-display">৳ 0</h3>
            </div>
            <div class="glass-card p-6 rounded-2xl row-span-2 md:col-span-2 lg:col-span-1">
                 <p class="text-gray-400 text-sm mb-4">Earnings Overview</p>
                 <canvas id="earningsChart" height="200"></canvas>
            </div>
        </div>

        <div class="glass-panel p-8 rounded-2xl mb-10 relative overflow-hidden">
            <h3 class="text-xl font-bold mb-4">Your Referral Link</h3>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1 bg-[#0F0A1E] border border-white/10 rounded-lg flex items-center px-4 py-3">
                    <input type="text" id="refLink" value="Loading..." readonly class="bg-transparent text-gray-200 w-full outline-none font-mono text-sm">
                </div>
                <button onclick="copyLink()" class="bg-[#A073EE] hover:bg-[#8b5cf6] text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all">
                    Copy Link
                </button>
            </div>
        </div>
    </div>

    <div x-show="currentTab === 'withdraw'" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Withdraw Money</h1>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="glass-card p-6 rounded-2xl bg-gradient-to-r from-[#A073EE]/10 to-[#fd297b]/10 border border-[#A073EE]/30">
                    <p class="text-gray-300 text-sm">Available to Withdraw</p>
                    <h2 class="text-4xl font-bold text-white balance-display">৳ 0</h2>
                </div>

                <div>
                    <h3 class="text-lg font-bold mb-4">Select Payment Method</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <label class="cursor-pointer relative group">
                            <input type="radio" name="payment_method" value="bkash" class="peer sr-only payment-radio">
                            <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center gap-2 h-28 hover:bg-white/5 transition-all">
                                <img src="./Source_Files/bkash.svg" class="h-10 w-auto" alt="Bkash">
                                <span class="text-xs font-bold">Bkash</span>
                            </div>
                        </label>
                        <label class="cursor-pointer relative group">
                            <input type="radio" name="payment_method" value="nagad" class="peer sr-only payment-radio">
                            <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center gap-2 h-28 hover:bg-white/5 transition-all">
                                <img src="./Source_Files/nagad.svg" class="h-10 w-auto" alt="Nagad">
                                <span class="text-xs font-bold">Nagad</span>
                            </div>
                        </label>
                        <label class="cursor-pointer relative group">
                            <input type="radio" name="payment_method" value="rocket" class="peer sr-only payment-radio">
                            <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center gap-2 h-28 hover:bg-white/5 transition-all">
                                <img src="./Source_Files/rocket.svg" class="h-10 w-auto" alt="Rocket">
                                <span class="text-xs font-bold">Rocket</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Amount (৳)</label>
                        <input type="number" id="withdrawAmount" placeholder="Any amount" class="w-full bg-[#1A1625] border border-white/10 rounded-lg px-4 py-3 text-white focus:border-[#fd297b] outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Account Number</label>
                        <input type="text" id="accountNumber" placeholder="017xxxxxxxx" class="w-full bg-[#1A1625] border border-white/10 rounded-lg px-4 py-3 text-white focus:border-[#fd297b] outline-none">
                    </div>
                </div>
                <button onclick="handleWithdraw()" class="w-full py-4 rounded-xl font-bold text-white bg-gradient-to-r from-[#fd297b] to-[#A073EE]">Submit Request</button>
            </div>
        </div>
    </div>
    
    <div x-show="currentTab === 'history'" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">History</h1>
        <div class="glass-panel rounded-2xl p-6">
             <h3 class="font-bold mb-4">Earnings</h3>
             <table class="w-full text-left text-sm text-gray-400"><tbody id="earnings-list"></tbody></table>
             <h3 class="font-bold mt-8 mb-4">Withdrawals</h3>
             <table class="w-full text-left text-sm text-gray-400"><tbody id="payment-list"></tbody></table>
        </div>
    </div>
  </main>

  <script>
    const token = localStorage.getItem('authToken');
    if (!token) window.location.href = "login.html";
    else loadDashboardData();

    // 1. Load Data & Setup Graph
    async function loadDashboardData() {
        try {
            const res = await fetch('/.netlify/functions/get-dashboard', { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const data = await res.json();
                
                // Update Texts
                document.querySelectorAll('.balance-display').forEach(el => el.innerText = `৳ ${data.balance}`);
                document.querySelector('.earning-display').innerText = `৳ ${data.totalEarnings}`;
                document.querySelector('.profile-name').innerText = data.name;
                document.querySelector('.profile-id').innerText = `ID: ${data.affiliateCode}`;
                document.getElementById('refLink').value = `https://metainjector.pro/?ref=${data.affiliateCode}`;
                
                // Set Avatar with Initials
                document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${data.name}&background=A073EE&color=fff`;

                // Setup Chart
                const ctx = document.getElementById('earningsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Available', 'Earnings'],
                        datasets: [{
                            data: [data.balance, data.totalEarnings],
                            backgroundColor: ['#fd297b', '#A073EE'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
                });

                // Load History
                loadEarningsHistory();
                loadPaymentHistory();
            }
        } catch (e) { console.error(e); }
    }

    // 2. Copy Link Function
    function copyLink() {
        const copyText = document.getElementById("refLink");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value);
        
        // Button Feedback
        const btn = document.querySelector('button[onclick="copyLink()"]');
        const originalText = btn.innerText;
        btn.innerText = "Copied!";
        setTimeout(() => btn.innerText = originalText, 2000);
    }

    // 3. Withdraw Function (No Min Limit)
    async function handleWithdraw() {
        const amount = document.getElementById('withdrawAmount').value;
        const account = document.getElementById('accountNumber').value;
        const method = document.querySelector('input[name="payment_method"]:checked')?.value;

        if(!amount || !account || !method) return alert("Please fill all fields");

        const btn = document.querySelector('button[onclick="handleWithdraw()"]');
        btn.innerText = "Processing...";
        
        try {
            const res = await fetch('/.netlify/functions/request-withdraw', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ amount, method, accountNumber: account })
            });
            const result = await res.json();
            if(res.ok) { alert("Request Submitted!"); window.location.reload(); }
            else alert("Error: " + result.error);
        } catch(e) { alert("Network Error"); }
        btn.innerText = "Submit Request";
    }

    // Helper functions for history... (Same as before)
    window.logout = () => { localStorage.removeItem('authToken'); window.location.href="login.html"; }
  </script>
</body>
</html>