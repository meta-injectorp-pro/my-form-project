<script>
    async function onPaymentSuccess(orderAmount, orderId, packageType, licenseKey) {
        console.log("Processing Referral...", { orderAmount, orderId, packageType, licenseKey });
        const allowedPackages = ['Starter', 'Beginner', 'Professional', 'Ultimate', 'Corporate', 'Enterprise'];
        if (!allowedPackages.includes(packageType)) return; 

        let refCode = null;
        try {
            const refData = localStorage.getItem("affiliate_ref");
            if (refData) {
                const item = JSON.parse(refData);
                if (new Date().getTime() < item.expiry) refCode = item.value;
                else localStorage.removeItem("affiliate_ref");
            }
        } catch (e) { console.error("Cookie Error:", e); }
        
        if (refCode) {
            try {
                await fetch('/.netlify/functions/add-commission', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refCode, amount: orderAmount, orderId, packageType, licenseKey })
                });
            } catch (err) {}
        }
    }

    let pendingFormData = null;
    let otpTimerInterval;
        
    function startOtpTimer() {
        clearInterval(otpTimerInterval);
        let timeRemaining = 600;
        const timerDisplay = document.getElementById('otp-timer');
        const verifyBtn = document.getElementById('verifyOtpBtn');
        
        timerDisplay.style.color = "#A073EE"; 
        verifyBtn.disabled = false;

        otpTimerInterval = setInterval(() => {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (timeRemaining <= 60) timerDisplay.style.color = "#ef4444";

            if (timeRemaining <= 0) {
                clearInterval(otpTimerInterval);
                timerDisplay.innerText = "0:00";
                document.getElementById('warnOtp').innerText = "Code expired. Please cancel and request again.";
                document.getElementById('warnOtp').style.display = 'block';
                verifyBtn.disabled = true; 
            }
            timeRemaining--;
        }, 1000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, ''); 
                if (e.target.value !== '' && index < otpInputs.length - 1) otpInputs[index + 1].focus(); 
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) otpInputs[index - 1].focus(); 
            });
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
                pastedData.split('').forEach((char, i) => {
                    if (i < otpInputs.length) {
                        otpInputs[i].value = char;
                        if (i < otpInputs.length - 1) otpInputs[i + 1].focus();
                    }
                });
            });
        });

        const packageDetails = {
            "Free Trial":   { label: "3 Days",   days: "3", credits: "50",    regular: 0 },
            "Starter":      { label: "1 Month",  days: "30", credits: "2,000",  regular: 200 }, 
            "Beginner":     { label: "1 Month",  days: "30", credits: "3,500",  regular: 350 },
            "Professional": { label: "2 Months", days: "60", credits: "6,000",  regular: 600 },
            "Ultimate":     { label: "3 Months", days: "90", credits: "10,000", regular: 950 },
            "Corporate":    { label: "6 Months", days: "180", credits: "20,000", regular: 1350 },
            "Enterprise":   { label: "1 Year",   days: "365", credits: "35,000", regular: 2000 }
        };

        const paymentNumbers = { "bKash": "01729816172", "Nagad": "01729816172", "Rocket": "01729816172" };

        const params = new URLSearchParams(window.location.search);
        const pkgName = params.get('package') || 'Starter';
        let pkgPrice = params.get('price') ? parseInt(params.get('price')) : 0;
        if(pkgName === "Free Trial") pkgPrice = 0;

        const elements = {
            pkgName: document.getElementById('pkgName'),
            pkgCredits: document.getElementById('pkgCredits'),
            pkgDuration: document.getElementById('pkgDurationDisplay'),
            totalPrice: document.getElementById('totalPrice'),
            priceRow: document.getElementById('priceRow'),
            regularPriceRow: document.getElementById('regularPriceRow'),
            regularPriceVal: document.getElementById('regularPriceVal'),
            discountRow: document.getElementById('discountRow'),
            discountVal: document.getElementById('discountVal'),
            discountBadge: document.getElementById('discountBadge'),
            paymentSection: document.getElementById('paymentSection'),
            payInstruction: document.getElementById('paymentInstruction'),
            payNumber: document.getElementById('payNumber'),
            trxGroup: document.getElementById('trxGroup'),
            submitBtn: document.getElementById('submitBtn'),
            checkoutGrid: document.getElementById('checkout-grid'),
            successView: document.getElementById('success-view'),
            statusMsg: document.getElementById('statusMsg'),
            copyBtn: document.getElementById('copyBtn'),
            copyTooltip: document.getElementById('copyTooltip')
        };

        elements.pkgName.innerText = pkgName;
        elements.totalPrice.innerText = 'à§³' + pkgPrice;

        let durationDays = "30";
        let regularPrice = 0;

        if (packageDetails[pkgName]) {
            elements.pkgDuration.innerText = packageDetails[pkgName].label;
            elements.pkgCredits.innerText = packageDetails[pkgName].credits;
            durationDays = packageDetails[pkgName].days;
            regularPrice = packageDetails[pkgName].regular;
        } else {
            elements.pkgDuration.innerText = "1 Month";
            elements.pkgCredits.innerText = params.get('credits') || "--";
        }

        const isFreeTrial = (pkgName === "Free Trial" || pkgPrice === 0);

        if (isFreeTrial) {
            elements.paymentSection.style.display = 'none';
            elements.priceRow.style.display = 'none';
            elements.submitBtn.innerText = "Start Your Free Trial";
        } else {
            const discountAmount = regularPrice - pkgPrice;
            if (regularPrice > pkgPrice) {
                elements.regularPriceVal.innerText = regularPrice;
                elements.discountVal.innerText = discountAmount;
                elements.regularPriceRow.classList.remove('hidden');
                elements.discountRow.classList.remove('hidden');
                elements.discountBadge.classList.remove('hidden');
            }
            elements.submitBtn.innerText = `Pay à§³${pkgPrice} & Confirm`;
        }

        document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const method = e.target.value;
                if(paymentNumbers[method]) {
                    elements.payNumber.innerText = paymentNumbers[method];
                    elements.payInstruction.classList.remove('hidden');
                    elements.trxGroup.classList.remove('hidden');
                }
            });
        });

        elements.copyBtn.addEventListener('click', () => {
            const number = elements.payNumber.innerText;
            navigator.clipboard.writeText(number).then(() => {
                elements.copyTooltip.style.opacity = '1';
                setTimeout(() => { elements.copyTooltip.style.opacity = '0'; }, 1500);
            });
        });

        const form = document.getElementById('checkoutForm');
        const inputs = {
            name: document.getElementById('fullName'),
            phone: document.getElementById('phone'),
            email: document.getElementById('email'),
            trx: document.getElementById('senderInfo'),
            terms: document.getElementById('termsCheck')
        };
        const warns = {
            name: document.getElementById('warnName'),
            phone: document.getElementById('warnPhone'),
            email: document.getElementById('warnEmail'),
            trx: document.getElementById('warnTrx'),
            terms: document.getElementById('warnTerms')
        };

        // ðŸ›¡ï¸ [NEW] Auto 01 Format & Limit for Phone
        inputs.phone.addEventListener('input', function() { 
            this.value = this.value.replace(/[^0-9]/g, ''); 
            if (this.value.length === 1 && this.value !== '0') this.value = '';
            if (this.value.length === 2 && this.value !== '01') this.value = '0';
            warns.phone.style.display = 'none';
            this.style.borderColor = '';
        });

        // ðŸ›¡ï¸ [NEW] Auto Capitalize Name
        inputs.name.addEventListener('input', function() { 
            let val = this.value.replace(/[^a-zA-Z\s]/g, ''); // Remove special chars
            this.value = val.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); // Capitalize first letter of each word
            warns.name.style.display = 'none';
            this.style.borderColor = '';
        });

        inputs.email.addEventListener('input', () => {
            warns.email.style.display = 'none';
            inputs.email.style.borderColor = '';
        });
        inputs.terms.addEventListener('change', () => {
            if(inputs.terms.checked) warns.terms.style.display = 'none';
        });

        if (inputs.trx) {
            inputs.trx.addEventListener('input', function() {
                this.value = this.value.toUpperCase().replace(/\s/g, ''); 
                warns.trx.style.display = 'none';
                this.style.borderColor = '';
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            let isValid = true;

            if (!inputs.terms.checked) { warns.terms.style.display = 'block'; isValid = false; }
            
            // ðŸ›¡ï¸ [NEW] Check for gibberish names (Must have vowels, length >= 3)
            const nameVal = inputs.name.value.trim();
            const hasVowel = /[aeiouAEIOU]/.test(nameVal);
            const tooManyConsonants = /[bcdfghjklmnpqrstvwxyzBCDFGHJKLMNPQRSTVWXYZ]{4,}/.test(nameVal);
            if (nameVal.length < 3 || !hasVowel || tooManyConsonants) { 
                warns.name.innerText = "Please enter a real valid name.";
                warns.name.style.display = 'block'; isValid = false; 
            }

            // ðŸ›¡ï¸ [NEW] Exact 11 digits & Starts with 01
            if (!/^01\d{9}$/.test(inputs.phone.value)) { 
                warns.phone.innerText = "Must be exactly 11 digits and start with 01.";
                warns.phone.style.display = 'block'; isValid = false; 
            }
            
            // ðŸ›¡ï¸ [NEW] Email Dot Trick & Alias block
            const emailVal = inputs.email.value.trim().toLowerCase();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
            if (!emailRegex.test(emailVal)) { 
                warns.email.innerText = "Please enter a valid email address.";
                warns.email.style.display = 'block'; isValid = false; 
            } else if (emailVal.includes('@gmail.com')) {
                const userPart = emailVal.split('@')[0];
                if (userPart.includes('+') || (userPart.match(/\./g) || []).length > 2) {
                    warns.email.innerText = "Suspicious Temp/Alias Gmail is not allowed.";
                    warns.email.style.display = 'block'; isValid = false; 
                }
            }

            let selectedMethodVal = "Free Trial";
            let trxVal = "N/A";
            
            if (!isFreeTrial) {
                const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
                if(!selectedMethod) { alert("Please select a payment method."); return; }
                selectedMethodVal = selectedMethod.value;
                trxVal = inputs.trx.value.trim();
                if (trxVal.length < 4) { warns.trx.style.display = 'block'; isValid = false; }
            }

            if(!isValid) return;

            pendingFormData = new FormData();
            pendingFormData.append('FullName', nameVal);
            pendingFormData.append('Email', emailVal);
            pendingFormData.append('Phone', inputs.phone.value);
            pendingFormData.append('Package', pkgName);
            pendingFormData.append('Duration', durationDays);
            pendingFormData.append('Price', pkgPrice);
            pendingFormData.append('PaymentMethod', selectedMethodVal);
            pendingFormData.append('SenderInfo', trxVal);
            pendingFormData.append('AmountSent', pkgPrice); 

            let rawRef = localStorage.getItem('affiliate_ref');
            let actualRefCode = 'None';
            if (rawRef) {
                try {
                    const parsedData = JSON.parse(rawRef);
                    if (parsedData !== null && typeof parsedData === 'object' && parsedData.value) {
                        actualRefCode = parsedData.value;
                    } else if (typeof parsedData === 'string') {
                        actualRefCode = parsedData;
                    } else {
                        actualRefCode = rawRef;
                    }
                } catch(e) { actualRefCode = rawRef; }
            }
            if (!actualRefCode || actualRefCode === 'null' || actualRefCode === 'undefined') {
                actualRefCode = 'None';
            }
            pendingFormData.append('ReferredBy', actualRefCode);

            if (isFreeTrial) {
                elements.submitBtn.disabled = true;
                elements.submitBtn.innerHTML = `Sending Verification Code...`;
                elements.statusMsg.style.display = 'none';

                try {
                    const res = await fetch('/.netlify/functions/send-otp', {
                        method: 'POST',
                        body: JSON.stringify({ email: emailVal, name: nameVal })
                    });
                    
                    if(res.ok) {
                        document.getElementById('otp-modal').classList.remove('hidden');
                        document.getElementById('otp-email-display').innerText = emailVal;
                        elements.submitBtn.innerHTML = `Start Your Free Trial`;
                        elements.submitBtn.disabled = false;
                        
                        startOtpTimer();
                        setTimeout(() => document.querySelectorAll('.otp-input')[0].focus(), 100);
                        
                    } else {
                        const errorData = await res.json();
                        throw new Error(errorData.error || 'Failed to send OTP.');
                    }
                } catch(error) {
                    elements.statusMsg.style.display = 'block';
                    elements.statusMsg.className = "mt-4 p-4 rounded-lg text-center border bg-red-900/50 border-red-500 text-red-200";
                    elements.statusMsg.innerHTML = `<strong>Error:</strong> ${error.message}`;
                    elements.submitBtn.disabled = false;
                    elements.submitBtn.innerText = "Start Your Free Trial";
                }
            } else {
                submitFinalData(pendingFormData, false);
            }
        });

        document.getElementById('cancelOtpBtn').addEventListener('click', () => {
            document.getElementById('otp-modal').classList.add('hidden');
            clearInterval(otpTimerInterval); 
        });

        document.getElementById('verifyOtpBtn').addEventListener('click', () => {
            const otpInputs = document.querySelectorAll('.otp-input');
            let otpVal = Array.from(otpInputs).map(i => i.value).join('');

            if(otpVal.length !== 6) {
                document.getElementById('warnOtp').innerText = "Please enter all 6 digits.";
                document.getElementById('warnOtp').style.display = 'block';
                return;
            }
            
            document.getElementById('warnOtp').style.display = 'none';
            const verifyBtn = document.getElementById('verifyOtpBtn');
            verifyBtn.innerText = "Verifying...";
            verifyBtn.disabled = true;

            pendingFormData.delete('OTP'); 
            pendingFormData.append('OTP', otpVal); 

            submitFinalData(pendingFormData, true); 
        });

        async function submitFinalData(formData, isFromModal) {
            const btn = isFromModal ? document.getElementById('verifyOtpBtn') : elements.submitBtn;
            if(!isFromModal) {
                btn.disabled = true;
                btn.innerHTML = `Processing...`;
                elements.statusMsg.style.display = 'none';
            }

            try {
                const response = await fetch('/.netlify/functions/submit-form', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if(response.ok) {
                    const orderId = formData.get('SenderInfo') || 'ORD-' + Date.now();
                    const licenseKey = data.licenseKey;

                    await onPaymentSuccess(pkgPrice, orderId, pkgName, licenseKey); 

                    clearInterval(otpTimerInterval);
                    document.getElementById('otp-modal').classList.add('hidden');
                    elements.checkoutGrid.style.display = 'none';
                    elements.successView.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    if (data.errorType === 'ACTIVE_PLAN') {
                        elements.statusMsg.style.display = 'block';
                        elements.statusMsg.className = "mt-6 p-1 rounded-2xl bg-gradient-to-r from-[#A073EE] via-purple-500 to-[#fd297b] p-[1px] relative overflow-hidden";
                        elements.statusMsg.innerHTML = `
                            <div class="bg-[#1A1625] rounded-2xl p-8 text-center h-full relative overflow-hidden">
                                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-40 h-20 bg-purple-500/20 blur-[50px] rounded-full pointer-events-none"></div>
                                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-yellow-500/10 border border-yellow-500/30 flex items-center justify-center animate-pulse">
                                    <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2">You already have an active paid subscription!</h3>
                                <p class="text-gray-300 text-sm mb-6 leading-relaxed">
                                    Instead of buying a new package, please <span class="text-[#A073EE] font-bold">Top Up Credits</span> to continue using the service.
                                </p>
                                <a href="/topup" class="group relative inline-flex items-center justify-center gap-2 w-full sm:w-auto px-8 py-3.5 rounded-xl bg-gradient-to-r from-[#A073EE] to-[#fd297b] text-white font-bold shadow-[0_0_20px_rgba(160,115,238,0.4)] hover:shadow-[0_0_35px_rgba(160,115,238,0.6)] hover:scale-[1.02] transition-all duration-300">
                                    <span>Top Up Credits Now</span>
                                    <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                    </svg>
                                </a>
                            </div>
                        `;
                        elements.submitBtn.style.display = 'none';
                        document.getElementById('otp-modal').classList.add('hidden');
                        elements.statusMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return; 
                    }

                    if (data.errorType === 'TRIAL_USED' || (data.message && data.message.includes('Free Trial'))) {
                        elements.statusMsg.style.display = 'block';
                        elements.statusMsg.className = "mt-6 p-1 rounded-2xl bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 p-[1px] relative overflow-hidden";
                        elements.statusMsg.innerHTML = `
                            <div class="bg-[#1A1625] rounded-2xl p-8 text-center h-full relative overflow-hidden">
                                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-40 h-20 bg-red-500/20 blur-[50px] rounded-full pointer-events-none"></div>
                                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/10 border border-red-500/30 flex items-center justify-center animate-pulse">
                                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2">Free Trial Already Used!</h3>
                                <p class="text-gray-300 text-sm mb-6 leading-relaxed">
                                    You have already claimed a Free Trial. To continue using Meta Injector Pro, please upgrade to a <span class="text-orange-400 font-bold">Premium Package</span>.
                                </p>
                                <a href="/index#pricing" class="group relative inline-flex items-center justify-center gap-2 w-full sm:w-auto px-8 py-3.5 rounded-xl bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold shadow-[0_0_20px_rgba(239,68,68,0.4)] hover:shadow-[0_0_35px_rgba(239,68,68,0.6)] hover:scale-[1.02] transition-all duration-300">
                                    <span>Upgrade to Premium</span>
                                    <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                    </svg>
                                </a>
                            </div>
                        `;
                        elements.submitBtn.style.display = 'none';
                        document.getElementById('otp-modal').classList.add('hidden');
                        elements.statusMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return; 
                    }

                    throw new Error(data.message || data.error || 'Submission failed');
                }
            } catch (error) {
                console.error(error);
                if(isFromModal) {
                    document.getElementById('warnOtp').innerText = error.message;
                    document.getElementById('warnOtp').style.display = 'block';
                    btn.disabled = false;
                    btn.innerText = "Verify & Start Trial";
                } else {
                    elements.statusMsg.style.display = 'block';
                    elements.statusMsg.className = "mt-4 p-4 rounded-lg text-center border bg-red-900/50 border-red-500 text-red-200";
                    elements.statusMsg.innerHTML = `<strong>Error:</strong> ${error.message}`;
                    btn.disabled = false;
                    btn.innerText = isFreeTrial ? "Start Your Free Trial" : "Confirm Purchase";
                }
            }
        }
    });
</script>
